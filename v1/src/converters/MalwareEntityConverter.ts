import {
  CONTAINER_MALWARE_ENTITY_CLASS,
  CONTAINER_MALWARE_ENTITY_TYPE,
  ContainerMalwareEntity,
} from "../jupiterone/entities";
import { ContainerMalware, Dictionary } from "../tenable/types";
import { generateEntityKey } from "../utils/generateKey";

export function createMalwareEntities(
  data: Dictionary<ContainerMalware[]>,
): ContainerMalwareEntity[] {
  const defaultValue: ContainerMalwareEntity[] = [];
  const vulnerabilityArrays = Object.values(data);

  const relationships = vulnerabilityArrays.reduce(
    (acc: ContainerMalwareEntity[], array) => {
      const relationsForOneReport: ContainerMalwareEntity[] = array.map(
        createMalwareEntity,
      );
      return acc.concat(relationsForOneReport);
    },
    defaultValue,
  );

  return relationships;
}

function createMalwareEntity(
  vulnerability: ContainerMalware,
): ContainerMalwareEntity {
  const malwareId = vulnerability.md5;
  return {
    _key: generateEntityKey(CONTAINER_MALWARE_ENTITY_TYPE, malwareId),
    _type: CONTAINER_MALWARE_ENTITY_TYPE,
    _class: CONTAINER_MALWARE_ENTITY_CLASS,
    _rawData: [{ name: "default", rawData: vulnerability }],
    infectedFile: vulnerability.infectedFile,
    fileTypeDescriptor: vulnerability.fileTypeDescriptor,
    md5: vulnerability.md5,
    sha256: vulnerability.sha256,
  };
}
